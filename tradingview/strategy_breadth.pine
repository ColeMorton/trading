//@version=5
indicator("BTC Strategy Breadth Oscillator", shorttitle="StgyBreadth", overlay=false)

// Description:
// This indicator calculates how many strategies from a predefined collection
// are currently in a bullish position. It functions as a breadth oscillator that shows
// market sentiment based on multiple strategies simultaneously.

// Strategy Definitions from CSV
// Includes SMA cross, EMA cross, and MACD strategies with their respective parameters

// ================ Main Configuration ================
var int totalStrategies = 11  // Total number of strategies to track
var float lowerBand = 0.0     // Minimum oscillator value
var float upperBand = 11.0    // Maximum oscillator value (total strategies)

// Default Colors
color bullColor = color.new(#26c6da, 0)
color bearColor = color.new(#7e57c2, 0)
color neutralColor = color.new(#3179f5, 0)

// Optional user inputs for time frame selection
timeframeInput = input.timeframe("D", "Strategy Timeframe", options=["H", "D", "W", "M"])

// ================ Strategy Functions ================

// Function to calculate SMA Crossover signal
smaCrossSignal(shortWindow, longWindow) =>
    shortSMA = ta.sma(close, shortWindow)
    longSMA = ta.sma(close, longWindow)
    
    // Current state
    crossUp = shortSMA > longSMA
    
    // Return the signal (true if bullish)
    crossUp

// Function to calculate EMA Crossover signal
emaCrossSignal(shortWindow, longWindow) =>
    shortEMA = ta.ema(close, shortWindow)
    longEMA = ta.ema(close, longWindow)
    
    // Current state
    crossUp = shortEMA > longEMA
    
    // Return the signal (true if bullish)
    crossUp

// Function to calculate MACD signal
macdSignal(shortWindow, longWindow, signalWindow) =>
    [macdLine, signalLine, _] = ta.macd(close, shortWindow, longWindow, signalWindow)
    
    // Current state
    crossUp = macdLine > signalLine
    
    // Return the signal (true if bullish)
    crossUp

// ================ Error Handling Function ================
checkParameter(param, paramName) =>
    if param <= 0
        runtime.error("Invalid " + paramName + ": " + str.tostring(param) + ". Must be positive.")
        0
    else
        param

// ================ Apply Strategies ================
calculateBreadth() =>
    int strategiesInPosition = 0
    
    // SMA Strategy 1: 104, 105
    shortSMA1 = checkParameter(104, "Short SMA Window")
    longSMA1 = checkParameter(105, "Long SMA Window")
    if smaCrossSignal(shortSMA1, longSMA1)
        strategiesInPosition += 1
    
    // SMA Strategy 2: 26, 38
    shortSMA2 = checkParameter(26, "Short SMA Window")
    longSMA2 = checkParameter(38, "Long SMA Window")
    if smaCrossSignal(shortSMA2, longSMA2)
        strategiesInPosition += 1
        
    // SMA Strategy 3: 27, 29
    shortSMA3 = checkParameter(27, "Short SMA Window")
    longSMA3 = checkParameter(29, "Long SMA Window")
    if smaCrossSignal(shortSMA3, longSMA3)
        strategiesInPosition += 1
        
    // SMA Strategy 4: 76, 78
    shortSMA4 = checkParameter(76, "Short SMA Window")
    longSMA4 = checkParameter(78, "Long SMA Window")
    if smaCrossSignal(shortSMA4, longSMA4)
        strategiesInPosition += 1
        
    // SMA Strategy 5: 11, 36
    shortSMA5 = checkParameter(11, "Short SMA Window")
    longSMA5 = checkParameter(36, "Long SMA Window")
    if smaCrossSignal(shortSMA5, longSMA5)
        strategiesInPosition += 1
        
    // SMA Strategy 6: 8, 44
    shortSMA6 = checkParameter(8, "Short SMA Window")
    longSMA6 = checkParameter(44, "Long SMA Window")
    if smaCrossSignal(shortSMA6, longSMA6)
        strategiesInPosition += 1
        
    // SMA Strategy 7: 3, 47
    shortSMA7 = checkParameter(3, "Short SMA Window")
    longSMA7 = checkParameter(47, "Long SMA Window")
    if smaCrossSignal(shortSMA7, longSMA7)
        strategiesInPosition += 1
    
    // EMA Strategy: 5, 68
    shortEMA1 = checkParameter(5, "Short EMA Window")
    longEMA1 = checkParameter(68, "Long EMA Window")
    if emaCrossSignal(shortEMA1, longEMA1)
        strategiesInPosition += 1
        
    // MACD Strategy 1: 14, 23, 13
    macdShort1 = checkParameter(14, "MACD Short Window")
    macdLong1 = checkParameter(23, "MACD Long Window")
    macdSignal1 = checkParameter(13, "MACD Signal Window")
    if macdSignal(macdShort1, macdLong1, macdSignal1)
        strategiesInPosition += 1
        
    // MACD Strategy 2: 18, 29, 18
    macdShort2 = checkParameter(18, "MACD Short Window")
    macdLong2 = checkParameter(29, "MACD Long Window")
    macdSignal2 = checkParameter(18, "MACD Signal Window")
    if macdSignal(macdShort2, macdLong2, macdSignal2)
        strategiesInPosition += 1
        
    // MACD Strategy 3: 3, 15, 3
    macdShort3 = checkParameter(3, "MACD Short Window")
    macdLong3 = checkParameter(15, "MACD Long Window")
    macdSignal3 = checkParameter(3, "MACD Signal Window")
    if macdSignal(macdShort3, macdLong3, macdSignal3)
        strategiesInPosition += 1
    
    strategiesInPosition

// Request data using the specified timeframe
[strategiesActive] = request.security(syminfo.tickerid, timeframeInput, [calculateBreadth()])

// ================ Calculate Oscillator And Bands ================

// Calculate percentage of active strategies
strategyPercentage = (strategiesActive / totalStrategies) * 100

// Moving averages for signal lines
slowMA = ta.sma(strategiesActive, 20)
fastMA = ta.sma(strategiesActive, 5)

// Overbought/Oversold Thresholds
overboughtThreshold = input.int(8, "Overbought Threshold", minval=1, maxval=totalStrategies)
oversoldThreshold = input.int(3, "Oversold Threshold", minval=0, maxval=totalStrategies-1)

// ================ Visualization ================

// Colors based on the position relative to thresholds
oscillatorColor = strategiesActive > overboughtThreshold ? bullColor : 
                  strategiesActive < oversoldThreshold ? bearColor : 
                  neutralColor

// Plotting the oscillator
plot(strategiesActive, "Active Strategies", color=oscillatorColor, linewidth=2)
plot(slowMA, "20-day SMA", color=color.new(#ffffff, 0), linewidth=1)

// Plot upper and lower reference lines - using dashed lines instead of style parameter
plot(overboughtThreshold, "Overbought", color=color.new(#26c6da, 40), linewidth=1)
plot(oversoldThreshold, "Oversold", color=color.new(#7e57c2, 40), linewidth=1)

// Plot range bands
hline(0, "Min", color=color.new(#787b86, 70), linestyle=hline.style_dotted)
hline(totalStrategies, "Max", color=color.new(#787b86, 70), linestyle=hline.style_dotted)

// ================ Alerts ================
// Create alerts for trading signals
crossingUp = ta.crossover(strategiesActive, oversoldThreshold)
crossingDown = ta.crossunder(strategiesActive, overboughtThreshold)
crossingMAUp = ta.crossover(fastMA, slowMA) 
crossingMADown = ta.crossunder(fastMA, slowMA)

// Alert conditions
alertcondition(crossingUp, "Breadth crossing up from oversold", "{{ticker}} breadth crossing above oversold level")
alertcondition(crossingDown, "Breadth crossing down from overbought", "{{ticker}} breadth crossing below overbought level")
alertcondition(crossingMAUp, "Fast MA crossing up Slow MA", "{{ticker}} breadth fast MA crossing above slow MA")
alertcondition(crossingMADown, "Fast MA crossing down Slow MA", "{{ticker}} breadth fast MA crossing below slow MA")

// Display aggregate statistics
var table infoTable = table.new(position.bottom_right, 2, 2, border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "Active Strategies", bgcolor=color.new(#000000, 90), text_color=color.white)
    table.cell(infoTable, 1, 0, str.tostring(strategiesActive) + " / " + str.tostring(totalStrategies), bgcolor=color.new(#000000, 90), text_color=oscillatorColor)
    table.cell(infoTable, 0, 1, "Percentage", bgcolor=color.new(#000000, 90), text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(math.round(strategyPercentage)) + "%", bgcolor=color.new(#000000, 90), text_color=oscillatorColor)