//@version=5
indicator("BTC Strategy Breadth Oscillator", shorttitle="StgyBreadth", overlay=false)

// Description:
// This indicator calculates how many strategies from a predefined collection
// are currently in a bullish position. It functions as a breadth oscillator that shows
// market sentiment based on multiple strategies simultaneously.

// ================ Main Configuration ================
var int totalStrategies = {{STRATEGY_COUNT}}  // Total number of strategies
var float lowerBand = 0.0     // Minimum oscillator value
var float upperBand = {{STRATEGY_COUNT}}.0    // Maximum oscillator value (total strategies)

// Default Colors
color bullColor = color.new(#26c6da, 0)
color bearColor = color.new(#7e57c2, 0)
color neutralColor = color.new(#3179f5, 0)

// Optional user inputs for time frame selection
timeframeInput = input.timeframe("D", "Strategy Timeframe", options=["H", "D", "W", "M"])

// Ticker selection for filtering strategies
tickerInput = input.string("{{DEFAULT_TICKER}}", "Ticker for Strategies", options={{TICKER_OPTIONS}})

// ================ Strategy Functions ================

// Function to calculate SMA Crossover signal
smaCrossSignal(shortWindow, longWindow) =>
    shortSMA = ta.sma(close, shortWindow)
    longSMA = ta.sma(close, longWindow)
    
    // Current state
    crossUp = shortSMA > longSMA
    
    // Return the signal (true if bullish)
    crossUp

// Function to calculate EMA Crossover signal
emaCrossSignal(shortWindow, longWindow) =>
    shortEMA = ta.ema(close, shortWindow)
    longEMA = ta.ema(close, longWindow)
    
    // Current state
    crossUp = shortEMA > longEMA
    
    // Return the signal (true if bullish)
    crossUp

// Function to calculate MACD signal
macdSignal(shortWindow, longWindow, signalWindow) =>
    [macdLine, signalLine, _] = ta.macd(close, shortWindow, longWindow, signalWindow)
    
    // Current state
    crossUp = macdLine > signalLine
    
    // Return the signal (true if bullish)
    crossUp

// ================ Error Handling Function ================
checkParameter(param, paramName) =>
    if param <= 0
        runtime.error("Invalid " + paramName + ": " + str.tostring(param) + ". Must be positive.")
        0
    else
        param

// ================ Strategy Configuration ================
// Strategy configuration - Hardcoded directly in calculateBreadth() function
// Source: {{CSV_PATH}}
// Generated: {{GENERATION_DATE}}
// Total strategies: {{STRATEGY_COUNT}}
{{TICKER_COUNTS}}

// ================ Dynamic Strategy Processing ================
calculateBreadth() =>
    int strategiesInPosition = 0
    int totalApplicableStrategies = 0
    
    // Process each strategy directly with hardcoded parameters
{{STRATEGY_BLOCKS}}
    
    // Return both the active strategies and the total applicable strategies
    [strategiesInPosition, totalApplicableStrategies]

// Request data using the specified timeframe
[strategiesActive, applicableStrategies] = request.security(syminfo.tickerid, timeframeInput, calculateBreadth())

// Update the total strategies variable based on applicable strategies
totalStrategies := applicableStrategies

// ================ Calculate Oscillator And Bands ================

// Calculate percentage of active strategies
strategyPercentage = (strategiesActive / totalStrategies) * 100

// Moving averages for signal lines
slowMA = ta.sma(strategiesActive, 20)
fastMA = ta.sma(strategiesActive, 5)

// Overbought/Oversold Thresholds
overboughtThreshold = input.int(8, "Overbought Threshold", minval=1, maxval={{STRATEGY_COUNT}})
oversoldThreshold = input.int(3, "Oversold Threshold", minval=0, maxval={{STRATEGY_COUNT_MINUS_1}})

// ================ Visualization ================

// Colors based on the position relative to thresholds
oscillatorColor = strategiesActive > overboughtThreshold ? bullColor : 
                  strategiesActive < oversoldThreshold ? bearColor : 
                  neutralColor

// Plotting the oscillator
plot(strategiesActive, "Active Strategies", color=oscillatorColor, linewidth=2)
plot(slowMA, "20-day SMA", color=color.new(#ffffff, 0), linewidth=1)

// Plot upper and lower reference lines - using dashed lines instead of style parameter
plot(overboughtThreshold, "Overbought", color=color.new(#26c6da, 40), linewidth=1)
plot(oversoldThreshold, "Oversold", color=color.new(#7e57c2, 40), linewidth=1)

// Plot range bands
hline(0, "Min", color=color.new(#787b86, 70), linestyle=hline.style_dotted)
hline({{STRATEGY_COUNT}}, "Max", color=color.new(#787b86, 70), linestyle=hline.style_dotted)

// ================ Alerts ================
// Create alerts for trading signals
crossingUp = ta.crossover(strategiesActive, oversoldThreshold)
crossingDown = ta.crossunder(strategiesActive, overboughtThreshold)
crossingMAUp = ta.crossover(fastMA, slowMA) 
crossingMADown = ta.crossunder(fastMA, slowMA)

// Alert conditions
alertcondition(crossingUp, "Breadth crossing up from oversold", "{{ticker}} breadth crossing above oversold level")
alertcondition(crossingDown, "Breadth crossing down from overbought", "{{ticker}} breadth crossing below overbought level")
alertcondition(crossingMAUp, "Fast MA crossing up Slow MA", "{{ticker}} breadth fast MA crossing above slow MA")
alertcondition(crossingMADown, "Fast MA crossing down Slow MA", "{{ticker}} breadth fast MA crossing below slow MA")

// Display aggregate statistics
var table infoTable = table.new(position.bottom_right, 2, 2, border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "Active Strategies", bgcolor=color.new(#000000, 90), text_color=color.white)
    table.cell(infoTable, 1, 0, str.tostring(strategiesActive) + " / " + str.tostring(totalStrategies), bgcolor=color.new(#000000, 90), text_color=oscillatorColor)
    table.cell(infoTable, 0, 1, "Percentage", bgcolor=color.new(#000000, 90), text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(math.round(strategyPercentage)) + "%", bgcolor=color.new(#000000, 90), text_color=oscillatorColor)