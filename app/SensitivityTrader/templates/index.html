{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">

<!-- Analysis Configuration -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title">Analysis Configuration</h5>
    </div>
    <div class="card-body">
        <div id="alert-container"></div>
        
        <div class="mb-3">
            <label for="tickers-input" class="form-label">Tickers (comma-separated)</label>
            <input type="text" class="form-control" id="tickers-input" placeholder="e.g., AAPL,MSFT,GOOG">
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="windows-input" class="form-label">Windows</label>
                <input type="number" class="form-control" id="windows-input" value="89">
            </div>
            <div class="col-md-4">
                <label class="form-label">Strategy Types</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sma-checkbox" checked>
                    <label class="form-check-label" for="sma-checkbox">SMA</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ema-checkbox" checked>
                    <label class="form-check-label" for="ema-checkbox">EMA</label>
                </div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="direction-select" class="form-label">Direction</label>
                <select class="form-select" id="direction-select">
                    <option value="Long" selected>Long</option>
                    <option value="Short">Short</option>
                </select>
            </div>
        </div>
        
        <div class="mb-3">
            <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#advancedConfig" aria-expanded="false" aria-controls="advancedConfig">
                Advanced Configuration
            </button>
            <div class="collapse" id="advancedConfig">
                <div class="card card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="refresh-checkbox" checked>
                                <label class="form-check-label" for="refresh-checkbox">Refresh</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="use-hourly-checkbox">
                                <label class="form-check-label" for="use-hourly-checkbox">Use Hourly</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="use-years-checkbox">
                                <label class="form-check-label" for="use-years-checkbox">Use Years</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="years-input" class="form-label">Years</label>
                            <input type="number" class="form-control" id="years-input" value="15">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="use-synthetic-checkbox">
                                <label class="form-check-label" for="use-synthetic-checkbox">Use Synthetic</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="use-current-checkbox" checked>
                                <label class="form-check-label" for="use-current-checkbox">Use Current</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="use-gbm-checkbox">
                                <label class="form-check-label" for="use-gbm-checkbox">Use GBM</label>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mt-3">Minimum Requirements</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="min-win-rate-input" class="form-label">Win Rate</label>
                            <input type="number" step="0.01" class="form-control" id="min-win-rate-input" value="0.44">
                        </div>
                        <div class="col-md-4">
                            <label for="min-trades-input" class="form-label">Trades</label>
                            <input type="number" class="form-control" id="min-trades-input" value="54">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="min-expectancy-input" class="form-label">Expectancy per Trade</label>
                            <input type="number" step="0.01" class="form-control" id="min-expectancy-input" value="1">
                        </div>
                        <div class="col-md-4">
                            <label for="min-profit-factor-input" class="form-label">Profit Factor</label>
                            <input type="number" step="0.01" class="form-control" id="min-profit-factor-input" value="1">
                        </div>
                        <div class="col-md-4">
                            <label for="min-sortino-input" class="form-label">Sortino Ratio</label>
                            <input type="number" step="0.01" class="form-control" id="min-sortino-input" value="0.4">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="sort-by-select" class="form-label">Sort By</label>
                            <select class="form-select" id="sort-by-select">
                                <option value="Score" selected>Score</option>
                                <option value="Win Rate [%]">Win Rate</option>
                                <option value="Total Trades">Total Trades</option>
                                <option value="Expectancy per Trade">Expectancy per Trade</option>
                                <option value="Profit Factor">Profit Factor</option>
                                <option value="Sortino Ratio">Sortino Ratio</option>
                                <option value="Total Return [%]">Total Return</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="sort-asc-checkbox">
                                <label class="form-check-label" for="sort-asc-checkbox">Sort Ascending</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <button id="run-analysis-btn" class="btn btn-primary">Run Analysis</button>
        </div>
        
        <div id="loading-indicator" class="mt-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2">Running analysis...</span>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i> Results
                </h5>
                <div class="d-flex">
                    <!-- CSV File Selector -->
                    <div id="csv-selector-container" class="me-3" style="display: none;">
                        <select id="csv-file-selector" class="form-select form-select-sm">
                            <option value="">Select a CSV file...</option>
                            <option value="current" selected>Current Results</option>
                        </select>
                    </div>
                    <div class="me-2">
                        <button id="download-csv-btn" class="btn btn-sm btn-outline-primary" style="display: none;">
                            <i class="fas fa-download"></i> Download CSV
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshTableBtn">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-outline-success" id="selectAllBtn">
                            <i class="fas fa-check-square me-1"></i> Select All
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="deselectAllBtn">
                            <i class="fas fa-square me-1"></i> Deselect All
                        </button>
                        <button class="btn btn-sm btn-primary" id="addToPortfolioBtn">
                            <i class="fas fa-plus me-1"></i> Add Selected to Portfolio
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="resultsTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Ticker</th>
                                <th>Strategy</th>
                                <th>Short Window</th>
                                <th>Long Window</th>
                                <th>Score</th>
                                <th>Win Rate</th>
                                <th>Profit Factor</th>
                                <th>Expectancy</th>
                                <th>Sortino Ratio</th>
                                <th>Total Return</th>
                                <th>Max Drawdown</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="loadingResults" class="text-center my-5 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing analysis, please wait...</p>
                </div>
                <div id="noResults" class="text-center my-5">
                    <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                    <p>No results yet. Run an analysis to see data here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="portfolio-section">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-briefcase me-2"></i> Portfolio Builder
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-danger" id="clearPortfolioBtn">
                        <i class="fas fa-trash me-1"></i> Clear Portfolio
                    </button>
                    <button class="btn btn-sm btn-primary" id="analyzePortfolioBtn">
                        <i class="fas fa-calculator me-1"></i> Analyze Portfolio
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="table-responsive">
                            <table id="portfolioTable" class="table table-striped table-hover" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Ticker</th>
                                        <th>Strategy</th>
                                        <th>Windows</th>
                                        <th>Score</th>
                                        <th>Win Rate</th>
                                        <th>Expectancy</th>
                                        <th>Weight</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Portfolio items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="emptyPortfolio" class="text-center my-5">
                            <i class="fas fa-folder-open fa-3x mb-3 text-muted"></i>
                            <p>Your portfolio is empty. Add backtest results from the results table.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Portfolio Analysis</h6>
                            </div>
                            <div class="card-body">
                                <div id="portfolioAnalysis">
                                    <p class="text-center text-muted">Add items to your portfolio and click "Analyze Portfolio" to see metrics.</p>
                                </div>
                                <div id="portfolioCharts" class="mt-4">
                                    <canvas id="portfolioMetricsChart"></canvas>
                                    <canvas id="portfolioDiversityChart" class="mt-3"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Weight Adjustment -->
<div class="modal fade" id="weightModal" tabindex="-1" aria-labelledby="weightModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="weightModalLabel">Adjust Portfolio Weight</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="weightForm">
                    <div class="mb-3">
                        <label for="portfolioWeight" class="form-label">Weight (1-10)</label>
                        <input type="range" class="form-range" min="1" max="10" step="1" id="portfolioWeight" value="1">
                        <div class="d-flex justify-content-between">
                            <span>1</span>
                            <span id="weightValue">1</span>
                            <span>10</span>
                        </div>
                    </div>
                    <input type="hidden" id="weightItemIndex">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveWeightBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            This is a notification message.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pass the default configuration to the client-side JavaScript
    const defaultConfig = {{ default_config|safe }};
</script>
<script src="{{ url_for('static', filename='js/analysis.js') }}"></script>
{% endblock %}
