import numpy as np
import pandas as pd
from scipy.spatial.distance import pdist, squareform

MAX_ROWS = 9


def calculate_strategy_correlation(df):
    # Extract the relevant columns for correlation calculation
    strategy_params = df[
        ["Strategy Type", "Short Window", "Long Window", "Signal Window"]
    ].copy()

    # Convert Strategy Type to numeric using one-hot encoding
    strategy_types = pd.get_dummies(strategy_params["Strategy Type"])

    # Combine with the numeric parameters
    features = pd.concat(
        [
            strategy_types,
            strategy_params[["Short Window", "Long Window", "Signal Window"]],
        ],
        axis=1,
    )

    # Normalize the features so they are on the same scale
    normalized_features = (features - features.mean()) / features.std()

    # Calculate pairwise distances between strategies
    distances = pdist(normalized_features.values, metric="euclidean")
    dist_matrix = squareform(distances)

    # Convert distances to similarity scores (closer to 1 = more similar)
    # Using negative exponential transformation
    similarity_matrix = np.exp(-dist_matrix / dist_matrix.max())

    # For each strategy, calculate the average similarity to all other strategies
    avg_similarities = similarity_matrix.mean(axis=1)

    # Convert to "uniqueness" score (1 - avg_similarity)
    # Higher score means more unique/different from others
    uniqueness_scores = 1 - avg_similarities

    # Scale to 0-1 range for easier interpretation
    min_score = uniqueness_scores.min()
    max_score = uniqueness_scores.max()
    uniqueness_scores = (uniqueness_scores - min_score) / (max_score - min_score)

    # Add the scores back to the original dataframe
    df["Correlation"] = uniqueness_scores

    return df


# Read the CSV data
data = """Ticker,Strategy Type,Short Window,Long Window,Signal Window,Signal Entry,Signal Exit,Total Open Trades,Total Trades,Score,Win Rate [%],Profit Factor,Expectancy per Trade,Sortino Ratio,Beats BNH [%],Avg Trade Duration,Trades Per Day,Trades per Month,Signals per Month,Expectancy per Month,Start,End,Period,Start Value,End Value,Total Return [%],Benchmark Return [%],Max Gross Exposure [%],Total Fees Paid,Max Drawdown [%],Max Drawdown Duration,Total Closed Trades,Open Trade PnL,Best Trade [%],Worst Trade [%],Avg Winning Trade [%],Avg Losing Trade [%],Avg Winning Trade Duration,Avg Losing Trade Duration,Expectancy,Sharpe Ratio,Calmar Ratio,Omega Ratio,Skew,Kurtosis,Tail Ratio,Common Sense Ratio,Value at Risk,Alpha,Beta,Daily Returns,Annual Returns,Cumulative Returns,Annualized Return,Annualized Volatility,Total Period
MSTR,MACD,13,21,32,false,false,1,155,1.72509245134951,44.8051948051948,2.4860226199646656,8.213211570016188,1.3793893618787834,18.18735816484827,23 days 09:11:41.298701298,0.015709705625182164,0.48093971631205673,0.9587765957446809,3.950059642494488,0,6768,6769 days 00:00:00,1000.0,694774.0187192436,69377.40187192436,3615.7870862610744,100.0,12123.34267387345,90.38661507823632,1920 days 00:00:00,154,142889.1891109579,172.7589740381635,-61.58299999999998,29.550868501592646,-9.107945233263523,37 days 11:07:49.565217391,11 days 22:52:14.117647058,3577.174218235622,0.8554841906302215,0.46811225427682246,1.2390063519183008,1.8569504309513716,62.692283341259724,1.2691606438795395,0.3758130081300813,-0.041439064398055954,None,None,0.0016169149996921898,0.40746257992243184,693.7740187192389,0.27584434305224104,0.5732207517285889,9802.857142857143
MSTR,EMA,6,23,0,false,false,1,150,1.6539263455222084,38.25503355704698,2.1532069093033535,12.692891764891446,1.5344653378189828,50.084524041444574,24 days 04:20:56.375838924,0.015199650247741184,0.4654255319148936,0.9277482269503546,5.9075959012127734,0,6768,6769 days 00:00:00,1000.0,1848107.623368487,184710.76233684868,3615.7870862610744,100.0,56287.623039397586,90.58898487833793,2310 days 00:00:00,149,383527.9482215161,669.0262975778547,-51.12041681384669,44.80751909335054,-7.204214297306037,48 days 18:31:34.736842105,8 days 22:41:44.347826086,9822.682383536718,0.9649482060447978,0.5521652636391469,1.265054527812216,0.540113195473574,41.6246022420171,1.3126233356700077,0.37190920145926226,-0.0377309049216652,None,None,0.0016678687841995513,0.4203029336182869,1847.1076233684705,0.3231695336153666,0.5242091292996939,9802.857142857143
MSTR,SMA,16,82,0,false,false,1,48,1.651504233004275,53.191489361702125,2.6645516713439705,37.12137376155984,1.5099734939343887,36.00514103148482,78 days 22:28:05.106382978,0.004794520547945206,0.14893617021276595,0.2947695035460993,5.52871524108338,0,6768,6769 days 00:00:00,1000.0,1339027.1106691263,133802.71106691263,3615.7870862610744,100.0,20945.812079704625,83.94428050240444,2354 days 00:00:00,47,36329.7367745752,489.9829015544042,-30.033379409144324,80.13482711966776,-11.757550509017353,120 days 00:57:36,32 days 05:27:16.363636363,27695.688806267037,0.9488048737999374,0.5650895784307082,1.2499730378948015,0.46562758214850786,38.96325064113741,1.243969965674392,0.3828396322778345,-0.03828862770079956,None,None,0.0015805166900626976,0.39829020589579983,1338.0271106691257,0.3073919574106998,0.5052064446880409,9802.857142857143
MSTR,SMA,18,21,0,false,false,1,242,1.6468359955946017,47.30290456431535,2.12649658153768,5.618468598140746,1.4815074949925984,35.0429152666469,15 days 01:59:30.124481326,0.0245846691926552,0.750886524822695,1.4986702127659575,4.2188323604833435,0,6768,6769 days 00:00:00,1000.0,1304235.07572344,130323.50757234398,3615.7870862610744,100.0,58327.30966469848,85.9624617378018,2357 days 00:00:00,241,77763.98253496108,481.51675392670165,-35.477187499999985,18.38476152496884,-5.841038438539588,20 days 13:15:47.368421052,10 days 04:09:26.929133858,5084.942295387876,0.9256519642236335,0.5493896620537289,1.2531267591226782,0.7228638670986582,38.839334820624956,1.3616813240710497,0.37525396180414466,-0.039026617935566124,None,None,0.0016449884216169213,0.41453708224746416,1303.2350757234274,0.3061112093909548,0.5389665608601955,9802.857142857143
MSTR,MACD,29,31,32,false,false,1,106,1.617010371449529,43.80952380952381,1.7845028841205919,12.27686272154586,1.2887820089069502,8.0884239323609,33 days 21:56:34.285714285,0.010711162926260565,0.32890070921985815,0.6546985815602837,4.037868856111271,0,6768,6769 days 00:00:00,1000.0,329618.05889096635,32861.805889096635,3615.7870862610744,100.0,7438.3179148690115,92.65682175995418,2026 days 00:00:00,105,77432.71190324554,374.40835500468,-67.99324999999999,41.826825365788665,-10.762091204473952,51 days 20:20:52.173913043,19 days 22:22:22.372881356,2392.241399883055,0.8043647834981758,0.3961138212188801,1.2183476619158946,1.0674290578450758,40.36964584577243,1.2290701935939239,0.3671985457483336,-0.04105195298635854,None,None,0.0014746228814277746,0.3716049661197992,328.6180588909656,0.24091455311008958,0.5559997840885106,9802.857142857143
MSTR,SMA,6,27,0,false,false,1,149,1.6027888121009712,38.513513513513516,1.9435254677957297,11.463977432084665,1.382035784364658,18.689694107572247,24 days 07:56:45.405405404,0.015097639172252987,0.46232269503546103,0.9215425531914894,5.300056942227086,0,6768,6769 days 00:00:00,1000.0,712937.416865905,71193.7416865905,3615.7870862610744,100.0,18305.5482176318,89.48038602708812,2310 days 00:00:00,148,146242.89535310923,621.5801948051948,-50.0000264924055,43.04846379075747,-8.319711825545548,44 days 22:18:56.842105263,11 days 10:17:08.571428571,3822.260280491864,0.8857871014981217,0.475067868004816,1.2398011156264153,0.3285525954815238,41.55104847633458,1.289907769125247,0.3707978938841637,-0.03790198916856498,None,None,0.0015258007564574365,0.384501790627274,711.9374168659054,0.2770707085505215,0.5224144445862402,9802.857142857143
MSTR,MACD,23,31,35,false,false,1,111,1.6027662124045017,41.81818181818181,1.7507207271356156,11.34299801136562,1.297340334066996,7.99475896044211,32 days 08:43:38.181818181,0.011221218303701545,0.34441489361702127,0.68572695035461,3.9066974533825736,0,6768,6769 days 00:00:00,1000.0,326231.3329319767,32523.13329319767,3615.7870862610744,100.0,7527.75547489344,85.70543428884207,1678 days 00:00:00,110,76637.11418520781,350.25419787430206,-67.99324999999999,41.586734076481235,-10.39468728543623,50 days 15:07:49.565217391,19 days 05:37:30,2259.9474431524436,0.793212033737115,0.42735375371554135,1.221782732900073,2.177792905143194,63.75255516879487,1.2264690228344863,0.3691343042071197,-0.04141452845852024,None,None,0.0015074473887657907,0.37987674196897925,325.23133293197736,0.24043752473983537,0.5763676170858526,9802.857142857143
MSTR,SMA,16,81,0,false,false,1,49,1.57100321203773,50.0,2.4812958405435914,35.77290242118251,1.472267110474359,27.64821417374173,77 days 07:00:00,0.004896531623433401,0.15203900709219859,0.30097517730496454,5.438876564922695,0,6768,6769 days 00:00:00,1000.0,1036858.4285385683,103585.84285385683,3615.7870862610744,100.0,17208.7381746237,86.21156941063771,1197 days 00:00:00,48,28131.464614246855,489.9829015544041,-30.033379409144324,83.15924443939679,-11.613439597031778,124 days 20:00:00,29 days 18:00:00,20994.311748423366,0.9259623703041391,0.526806030812441,1.2432239508122083,0.46760113129945174,38.88597339056883,1.2458861005998163,0.3811467047541318,-0.038402331462042034,None,None,0.0015430950056893906,0.38885994143372643,1035.8584285385652,0.29500319025928134,0.5054125599127087,9802.857142857143
MSTR,MACD,9,13,5,false,false,0,403,1.563679999531313,41.43920595533499,3.1358321812594054,3.003338331466708,1.6209350735118289,58.50656464508285,8 days 15:46:53.895781636,0.04111046342174293,1.2504432624113475,2.500886524822695,3.7555041813242833,0,6768,6769 days 00:00:00,1000.0,2152630.679914504,215163.06799145037,3615.7870862610744,100.0,62987.6727475123,82.05310804849529,3977 days 00:00:00,403,0.0,128.4712106704712,-35.71772540983606,14.636488036161074,-5.2285938748212555,12 days 20:07:11.137724550,5 days 16:46:46.779661016,5339.0339451972795,0.9290278648716932,0.6247057280454932,1.263139246304399,3.208909588265415,53.778502572718246,1.5094657206404178,0.3524475524475525,-0.04069079638649118,None,None,0.0017462654609152303,0.44005889615063803,2151.630679914509,0.3307044082518922,0.5700700522812884,9802.857142857143
MSTR,SMA,4,32,0,false,false,1,151,1.5454924898563696,38.0,1.527060966488815,8.844105042783745,1.3155366143707639,10.015386655649047,23 days 18:52:47.999999999,0.015301661323229378,0.46852836879432624,0.9339539007092199,4.143714109141143,0,6768,6769 days 00:00:00,1000.0,399292.9281966839,39829.292819668386,3615.7870862610744,100.0,20230.241110052386,91.97966631125018,2388 days 00:00:00,150,82119.7125835814,389.5855398205281,-31.83499999999999,36.28277711406185,-7.973145581547994,45 days 16:25:15.789473684,10 days 08:46:27.096774193,2107.8214374206827,0.8351716183047224,0.4144775930295259,1.2267384397902585,0.5160721073379929,42.38194925527427,1.2933794415083582,0.3633434038267875,-0.0381180772327241,None,None,0.0014361321371136042,0.36190529855262826,398.2929281966806,0.24980510413270096,0.521513285034107,9802.857142857143
MSTR,EMA,40,65,0,false,false,1,37,1.5409625970844185,41.66666666666667,4.86639921419603,36.3874716599388,1.3158758709131206,9.257234660947173,101 days 02:40:00,0.003672398717575051,0.1148049645390071,0.22650709219858156,4.177462393583399,0,6768,6769 days 00:00:00,1000.0,371879.7662780227,37087.97662780227,3615.7870862610744,100.0,3476.263238548403,85.92691145604145,2382 days 00:00:00,36,39596.24441357545,389.8351063829787,-27.708695652173905,103.25081540506605,-11.372059586580693,185 days 14:24:00,40 days 18:17:08.571428571,9202.320051790204,0.8329050069624022,0.4375205888891718,1.2180699305574998,0.49578268895660965,38.2219066464541,1.2094546372510542,0.3727438653417157,-0.03936966375003472,None,None,0.0014001800176117562,0.35284536443816256,370.87976627802345,0.2465001610801747,0.5098414084259552,9802.857142857143
MSTR,EMA,39,53,0,false,false,1,38,1.5376112075387915,43.24324324324324,3.8076022432328314,38.19691313034195,1.3717309437566667,13.881488302829526,98 days 16:51:53.513513513,0.003774409793063247,0.11790780141843972,0.2327127659574468,4.503714048169751,0,6768,6769 days 00:00:00,1000.0,539082.9322971622,53808.29322971623,3615.7870862610744,100.0,6186.037398396333,85.5067368911707,2380 days 00:00:00,37,32142.39251217729,413.07052631578955,-34.608720746942126,102.96013124285537,-11.146491145858747,177 days 10:30:00,38 days 17:08:34.285714286,13674.068642837432,0.8653993622790589,0.4722128495812611,1.2280735735660682,0.5108475288388958,38.26710311478408,1.214775538118684,0.37525396180414466,-0.039026617935566076,None,None,0.0014551518036477924,0.3666982545192437,538.0829322971641,0.26385006246666376,0.5099627257244712,9802.857142857143
MSTR,MACD,7,8,12,false,false,0,379,1.5243080561083353,39.84168865435356,2.967833041268804,3.1134156003962543,1.5673723565604674,41.93777682535384,9 days 05:41:57.150395778,0.03866219761002623,1.1759751773049645,2.351950354609929,3.6612994627000277,0,6768,6769 days 00:00:00,1000.0,1553538.5895787447,155253.85895787447,3615.7870862610744,100.0,44028.12989984919,85.64283662461251,3492 days 00:00:00,379,0.0,128.4712106704712,-36.94600409836066,16.11540760384915,-5.497552787855444,13 days 19:52:03.178807947,6 days 04:44:12.631578947,4096.407888070567,0.9032452212917047,0.5677311115104209,1.2533696593789494,3.1564214433835067,53.35616625542225,1.485448865843806,0.35298820707575457,-0.04169402368530131,None,None,0.0017010917088979445,0.42867511064228203,1552.538589578746,0.31464431112789404,0.5711744312141005,9802.857142857143
MSTR,EMA,35,76,0,false,false,1,38,1.516533383687309,40.54054054054054,4.341294509614833,33.83839000492819,1.2576962923398463,5.947922015192468,98 days 11:01:37.297297297,0.003774409793063247,0.11790780141843972,0.2327127659574468,3.9898101690207888,0,6768,6769 days 00:00:00,1000.0,252222.06698881945,25122.206698881946,3615.7870862610744,100.0,2465.1598236477803,85.07449629834915,2388 days 00:00:00,37,29821.087867183087,377.14248704663214,-27.708695652173905,100.66531116279411,-11.72541987543494,186 days 04:48:00,38 days 15:16:21.818181818,5983.810246530713,0.798226649517687,0.40839579639126466,1.208007597391347,0.4858923337926794,37.79629388679743,1.2020956515639838,0.37302231237322514,-0.03949466413841033,None,None,0.0013462091878164836,0.33924471532975387,251.2220669888186,0.22861236548331076,0.5114851506720934,9802.857142857143
MSTR,EMA,25,51,0,false,false,1,52,1.5117722916907472,50.98039215686274,1.9334795998825254,30.56212398898167,1.3150118878467385,9.602935958903489,72 days 10:49:24.705882352,0.005202564849897989,0.16134751773049646,0.3195921985815603,4.931122842193852,0,6768,6769 days 00:00:00,1000.0,384379.5891665641,38337.95891665641,3615.7870862610744,100.0,9300.098354594957,89.71129265152382,2380 days 00:00:00,51,45446.52908342064,597.4473684210525,-36.48008430237283,72.41311950656075,-12.962911349300565,122 days 04:36:55.384615384,20 days 17:16:48,6626.138433002812,0.8353025968859166,0.42180083107509153,1.2168887643235808,0.41540857429522465,37.589713358597,1.2300017898012074,0.37777325463057193,-0.0390994770364314,None,None,0.0014107726353368493,0.35551470410488606,383.37958916656487,0.24803526683754806,0.5122239703504295,9802.857142857143
MSTR,SMA,17,21,0,false,false,1,221,1.5080299278958385,45.0,1.649960987459284,5.446771533812615,1.243950936160306,5.982300676750718,16 days 11:53:27.272727271,0.02244243660740309,0.68572695035461,1.3683510638297873,3.7349980331596253,0,6768,6769 days 00:00:00,1000.0,253465.12619387204,25246.512619387206,3615.7870862610744,100.0,15359.128329780286,89.92500056027876,2383 days 00:00:00,220,15112.657229854696,446.64764397905765,-36.86055045871558,20.380655220768077,-6.771860573696401,24 days 06:47:16.363636363,10 days 02:58:30.743801652,1078.8748589273512,0.7908823587739748,0.3867644346466852,1.2126957139414027,0.5903461598935178,39.18426780467704,1.3109511034885912,0.37302231237322514,-0.03917067854848393,None,None,0.0014010817741327564,0.3530726070814546,252.46512619387374,0.22883725612445094,0.5372770598360579,9802.857142857143
MSTR,SMA,34,84,0,false,false,1,38,1.4777884508176002,59.45945945945946,2.039870374452958,32.33687746484314,1.1271087139103186,2.011161526942844,101 days 08:25:56.756756756,0.003774409793063247,0.11790780141843972,0.2327127659574468,3.8127701266171434,0,6768,6769 days 00:00:00,1000.0,109877.18963766114,10887.718963766114,3615.7870862610744,100.0,2145.237165052334,93.77362525368878,2380 days 00:00:00,37,-639.5189677780581,428.3757467840891,-59.024466347569174,67.03679405923359,-18.556333540262845,136 days 21:49:05.454545454,49 days 04:48:00,2959.91104339025,0.7258090573974625,0.3075482079169255,1.1856189953019145,0.3407933503617227,37.14831451727472,1.1856189953019156,0.38567041965199594,-0.039845377904974916,None,None,0.0012307910848174011,0.3101593533739851,108.87718963766099,0.19118718330403817,0.5142906881119323,9802.857142857143
MSTR,SMA,6,81,0,false,false,1,67,1.457635294459317,40.909090909090914,2.2159377839196726,29.62743443218309,1.3933074522457647,15.977839204204564,55 days 16:43:38.181818181,0.006732730982220926,0.20789007092198583,0.412677304964539,6.159249445343027,0,6768,6769 days 00:00:00,1000.0,614882.5174717986,61388.25174717986,3615.7870862610744,100.0,13226.252537503873,87.510665427895,2382 days 00:00:00,66,76933.91765295435,968.2606217616583,-33.66204653338815,87.47307778721222,-10.419549428990933,107 days 19:33:20,19 days 14:46:09.230769231,8135.584845740064,0.8823871451508148,0.47281978158183524,1.2318911729741315,0.37965318263527364,40.01875693728267,1.2391804698556377,0.37861507128309574,-0.03828862770079971,None,None,0.00145908014174864,0.36768819572065725,613.8825174718007,0.27005539947912593,0.501495080113319,9802.857142857143
MSTR,MACD,30,35,35,false,false,1,103,1.449902294472188,45.09803921568628,1.7018355717351892,14.414190143185625,1.2146557350600826,4.215486318076198,35 days 01:38:49.411764704,0.010405129699795977,0.3195921985815603,0.636081560283688,4.606662718633349,0,6768,6769 days 00:00:00,1000.0,189580.88077471234,18858.088077471235,3615.7870862610744,100.0,5187.682784997966,93.6432498096734,2349 days 00:00:00,102,38989.73996577505,624.2504531722055,-67.99324999999999,45.96105594096231,-11.499306762130937,56 days 05:13:02.608695652,17 days 16:42:51.428571428,1466.5798118523262,0.7600670839128484,0.34904420845278034,1.2050038749542655,1.0588732541264043,40.59748484233387,1.228228068579487,0.36664647688269736,-0.04129214363712558,None,None,0.0013905601566484582,0.35042115947541147,188.58088077471197,0.21562317024236988,0.5548614584640907,9802.857142857143"""

# Convert string data to a dataframe
lines = data.strip().split("\n")
header = lines[0].split(",")
rows = [line.split(",") for line in lines[1:]]
df = pd.DataFrame(rows, columns=header)

# Convert numeric columns to appropriate types
for col in ["Short Window", "Long Window", "Signal Window", "Score"]:
    df[col] = pd.to_numeric(df[col])

# Calculate correlation
df = calculate_strategy_correlation(df)

# Calculate Value column (Score * Correlation)
df["Value"] = df["Score"] * df["Correlation"]

# Sort by Value in descending order
df = df.sort_values(by="Value", ascending=False)

# Ensure strategy type diversity in results
# First, get the top strategy of each type
strategy_types = df["Strategy Type"].unique()
selected_indices = []

# Get the best strategy of each type
for strategy_type in strategy_types:
    type_df = df[df["Strategy Type"] == strategy_type]
    if not type_df.empty:
        # Get the index of the top strategy of this type
        top_idx = type_df.index[0]
        selected_indices.append(top_idx)

# If we have fewer strategies than MAX_ROWS, fill with next best overall
remaining_slots = MAX_ROWS - len(selected_indices)
if remaining_slots > 0:
    # Get indices of remaining top strategies, excluding those already selected
    remaining_indices = [idx for idx in df.index if idx not in selected_indices]
    # Take only as many as we need to fill remaining slots
    additional_indices = remaining_indices[:remaining_slots]
    selected_indices.extend(additional_indices)

# Create result DataFrame from selected indices, limited to MAX_ROWS
result = df.loc[selected_indices[:MAX_ROWS]]

# Display results with selected columns
result = result[
    [
        "Ticker",
        "Strategy Type",
        "Short Window",
        "Long Window",
        "Signal Window",
        "Correlation",
        "Score",
        "Value",
    ]
]
print(result)
