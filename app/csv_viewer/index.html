<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CSV Viewer</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <link
        rel="stylesheet"
        href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
        />
        <style>
        table.dataTable {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            border: 1px solid #e5e7eb; /* Tailwindのgray-200 */
        }

        table.dataTable thead th {
            background-color: #f9fafb; /* Tailwindのgray-50 */
            color: #374151; /* Tailwindのgray-700 */
            text-align: left;
            padding: 0.5rem;
            font-size: 1rem; /* Tailwindのtext-sm */
            font-weight: 500; /* Tailwindのfont-medium */
        }

        table.dataTable tbody td {
            padding: 0.5rem;
            font-size: 1rem; /* Tailwindのtext-sm */
            color: #374151; /* Tailwindのgray-700 */
        }

        table.dataTable tbody tr:hover {
            background-color: #f3f4f6; /* Tailwindのgray-100 */
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.25rem 0.5rem;
            margin: 0 0.25rem;
            border: 1px solid #e5e7eb; /* Tailwindのgray-200 */
            border-radius: 0.375rem; /* Tailwindのrounded-lg */
            color: #374151; /* Tailwindのgray-700 */
            background-color: white;
            font-size: 1rem; /* Tailwindのtext-sm */
            transition: all 0.2s;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #f9fafb; /* Tailwindのgray-50 */
            border-color: #d1d5db; /* Tailwindのgray-300 */
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #6366f1; /* Tailwindのindigo-600 */
            color: white;
            border-color: #6366f1;
        }

        .dataTables_filter {
            margin-bottom: 1rem;
        }
        </style>
    </head>
    <body class="bg-gray-50 p-6">
        <div class="max-w-full mx-auto">
            <h1 class="text-2xl font-bold mb-4">CSV Viewer</h1>
            
            <!-- File selector section with Update button -->
            <div class="mb-4 p-3 bg-white rounded shadow-sm">
                <div class="flex items-center space-x-2">
                    <div class="flex-grow">
                        <label for="file-selector" class="block text-sm font-medium text-gray-700 mb-2">Select CSV File:</label>
                        <select id="file-selector" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select a file...</option>
                        </select>
                    </div>
                    <div class="pt-6">
                        <button id="update-button" disabled class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            Update
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- File info section -->
            <div id="file-info" class="mb-4 p-3 bg-white rounded shadow-sm"></div>
            
            <!-- Loading indicator -->
            <div id="loading" class="flex items-center justify-center p-6">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <span class="ml-3">Loading CSV data...</span>
            </div>
            
            <!-- Error message -->
            <div id="error-message" class="hidden p-4 mb-4 text-red-700 bg-red-100 rounded-lg"></div>
            
            <!-- Update status message -->
            <div id="update-status" class="hidden mb-4 p-3 rounded shadow-sm"></div>
            
            <!-- Table container -->
            <div id="table-container" class="hidden overflow-x-auto bg-white rounded-lg shadow-lg p-4">
                <table id="csv-table" class="w-full"></table>
            </div>
        </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const fileSelector = document.getElementById('file-selector');
                const tableContainer = document.getElementById('table-container');
                const loadingIndicator = document.getElementById('loading');
                const errorMessage = document.getElementById('error-message');
                const fileInfo = document.getElementById('file-info');
                
                // Function to show error
                function showError(message) {
                    errorMessage.textContent = message;
                    errorMessage.classList.remove('hidden');
                    loadingIndicator.classList.add('hidden');
                }
                
                // Function to load file list
                function loadFileList() {
                    loadingIndicator.classList.remove('hidden');
                    
                    fetch('/api/data/list/strategies')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load file list');
                            }
                            return response.json();
                        })
                        .then(data => {
                            loadingIndicator.classList.add('hidden');
                            
                            if (!data || !data.files) {
                                throw new Error('Invalid response format');
                            }
                            
                            // Filter for CSV files only
                            const csvFiles = data.files.filter(file => file.path.endsWith('.csv'));
                            
                            // Sort files by filename (not the full path)
                            csvFiles.sort((a, b) => {
                                const filenameA = a.path.split('/').pop();
                                const filenameB = b.path.split('/').pop();
                                return filenameA.localeCompare(filenameB);
                            });
                            
                            // Add sorted files to selector
                            csvFiles.forEach(file => {
                                const option = document.createElement('option');
                                option.value = file.path;
                                option.textContent = file.path.split('/').pop();
                                fileSelector.appendChild(option);
                            });
                        })
                        .catch(error => {
                            showError('Error loading file list: ' + error.message);
                        });
                }
                
                // Function to load CSV data
                function loadCSVData(filePath) {
                    loadingIndicator.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                    errorMessage.classList.add('hidden');
                    
                    fetch(`/api/data/csv/${filePath}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load CSV file');
                            }
                            return response.json();
                        })
                        .then(response => {
                            // Hide loading indicator
                            loadingIndicator.classList.add('hidden');
                            
                            if (!response || !response.data || !response.data.data) {
                                showError('Invalid response format');
                                return;
                            }
                            
                            const data = response.data.data;
                            
                            if (data.length === 0) {
                                showError('No data found in the CSV file.');
                                return;
                            }
                            
                            // Display file info
                            fileInfo.innerHTML = `
                                <p><strong>File:</strong> ${filePath.split('/').pop()}</p>
                                <p><strong>Rows:</strong> ${data.length}</p>
                                <p><strong>Columns:</strong> ${Object.keys(data[0]).length}</p>
                            `;
                            
                            // Show table container
                            tableContainer.classList.remove('hidden');
                            
                            // Find the index of the "Score" column
                            const columns = Object.keys(data[0]);
                            const scoreColumnIndex = columns.findIndex(col => col === "Score");
                            
                            // Initialize DataTable
                            $('#csv-table').DataTable({
                                destroy: true, // Destroy existing table
                                data: data,
                                columns: columns.map(key => ({
                                    title: key,
                                    data: key
                                })),
                                scrollX: true,
                                scrollY: '70vh',
                                scrollCollapse: true,
                                paging: false,
                                searching: true,
                                ordering: true,
                                info: true,
                                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                                pageLength: "All",
                                responsive: true,
                                // Set default sort to "Score" column in descending order if it exists
                                order: scoreColumnIndex !== -1 ? [[scoreColumnIndex, 'desc']] : []
                            });
                        })
                        .catch(error => {
                            showError('Error loading CSV file: ' + error.message);
                        });
                }
                // Event listener for file selector
                fileSelector.addEventListener('change', function() {
                    if (this.value) {
                        loadCSVData(this.value);
                        
                        // Enable Update button when a file is selected
                        const updateButton = document.getElementById('update-button');
                        updateButton.disabled = false;
                    } else {
                        // Disable Update button when no file is selected
                        const updateButton = document.getElementById('update-button');
                        updateButton.disabled = true;
                    }
                });
                
                // Add event listener for Update button
                document.getElementById('update-button').addEventListener('click', function() {
                    const filePath = fileSelector.value;
                    if (!filePath) return;
                    
                    // Show loading state
                    this.disabled = true;
                    this.innerHTML = '<span class="animate-spin inline-block mr-2">↻</span> Updating...';
                    
                    // Hide previous status
                    const updateStatus = document.getElementById('update-status');
                    updateStatus.classList.add('hidden');
                    
                    // Get just the filename without the path
                    const fileName = filePath.split('/').pop();
                    
                    // Make API request to update portfolio
                    fetch('/api/scripts/update-portfolio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            portfolio: fileName
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Show status message
                        updateStatus.classList.remove('hidden');
                        
                        if (data.status === "accepted") {
                            updateStatus.className = 'mb-4 p-3 bg-blue-100 text-blue-800 rounded shadow-sm';
                            updateStatus.textContent = `Portfolio update started. Execution ID: ${data.execution_id}`;
                            // Store button reference for use in event handlers
                            const updateButton = this;
                            
                            // Create SSE connection
                            const executionId = data.execution_id;
                            const eventSource = new EventSource(`/api/scripts/status-stream/${executionId}`);
                            
                            // Handle incoming messages
                            eventSource.onmessage = function(event) {
                                try {
                                    const statusData = JSON.parse(event.data);
                                    
                                    // Update status message based on progress
                                    if (statusData.status === "completed") {
                                        // Update status message
                                        updateStatus.className = 'mb-4 p-3 bg-green-100 text-green-800 rounded shadow-sm';
                                        updateStatus.textContent = 'Portfolio updated successfully!';
                                        
                                        // Reset button
                                        updateButton.disabled = false;
                                        updateButton.textContent = 'Update';
                                        
                                        // Reload the CSV data to refresh the table
                                        loadCSVData(filePath);
                                        
                                        // Close the connection
                                        eventSource.close();
                                    } else if (statusData.status === "failed") {
                                        // Update status message
                                        updateStatus.className = 'mb-4 p-3 bg-red-100 text-red-800 rounded shadow-sm';
                                        updateStatus.textContent = `Update failed: ${statusData.error || 'Unknown error'}`;
                                        
                                        // Reset button
                                        updateButton.disabled = false;
                                        updateButton.textContent = 'Update';
                                        
                                        // Close the connection
                                        eventSource.close();
                                    } else {
                                        // Update progress message
                                        const progressText = statusData.progress ? `(${statusData.progress}%)` : '';
                                        updateStatus.textContent = `Portfolio update in progress... Status: ${statusData.status} ${progressText}`;
                                        
                                        // Add progress bar if not already present
                                        if (!document.getElementById('progress-bar-container')) {
                                            const progressContainer = document.createElement('div');
                                            progressContainer.id = 'progress-bar-container';
                                            progressContainer.className = 'w-full bg-gray-200 rounded-full h-2.5 mt-2';
                                            
                                            const progressBar = document.createElement('div');
                                            progressBar.id = 'progress-bar';
                                            progressBar.className = 'bg-indigo-600 h-2.5 rounded-full';
                                            progressBar.style.width = `${statusData.progress || 0}%`;
                                            
                                            progressContainer.appendChild(progressBar);
                                            updateStatus.appendChild(progressContainer);
                                        } else {
                                            // Update existing progress bar
                                            const progressBar = document.getElementById('progress-bar');
                                            if (progressBar) {
                                                progressBar.style.width = `${statusData.progress || 0}%`;
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error parsing SSE message:', error);
                                }
                            };
                            
                            // Handle connection errors
                            eventSource.onerror = function(error) {
                                console.error('SSE connection error:', error);
                                
                                // Update status message
                                updateStatus.className = 'mb-4 p-3 bg-red-100 text-red-800 rounded shadow-sm';
                                updateStatus.textContent = `Error checking status: Connection lost`;
                                
                                // Reset button
                                updateButton.disabled = false;
                                updateButton.textContent = 'Update';
                                
                                // Close the connection
                                eventSource.close();
                            };
                        } else {
                            updateStatus.className = 'mb-4 p-3 bg-red-100 text-red-800 rounded shadow-sm';
                            updateStatus.textContent = `Error: ${data.message || 'Unknown error'}`;
                            
                            // Reset button
                            this.disabled = false;
                            this.textContent = 'Update';
                        }
                    })
                    .catch(error => {
                        // Reset button
                        this.disabled = false;
                        this.textContent = 'Update';
                        
                        // Show error message
                        updateStatus.classList.remove('hidden');
                        updateStatus.className = 'mb-4 p-3 bg-red-100 text-red-800 rounded shadow-sm';
                        updateStatus.textContent = `Error starting update: ${error.message}`;
                    });
                });
                
                // Load file list on page load
                loadFileList();
            });
        </script>
    </body>
</html>