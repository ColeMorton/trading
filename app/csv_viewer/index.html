<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CSV Viewer</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <link
        rel="stylesheet"
        href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
        />
        <style>
        table.dataTable {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            border: 1px solid #e5e7eb; /* Tailwindのgray-200 */
        }

        table.dataTable thead th {
            background-color: #f9fafb; /* Tailwindのgray-50 */
            color: #374151; /* Tailwindのgray-700 */
            text-align: left;
            padding: 0.5rem;
            font-size: 0.875rem; /* Tailwindのtext-sm */
            font-weight: 500; /* Tailwindのfont-medium */
        }

        table.dataTable tbody td {
            padding: 0.5rem;
            font-size: 0.875rem; /* Tailwindのtext-sm */
            color: #374151; /* Tailwindのgray-700 */
        }

        table.dataTable tbody tr:hover {
            background-color: #f3f4f6; /* Tailwindのgray-100 */
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.25rem 0.5rem;
            margin: 0 0.25rem;
            border: 1px solid #e5e7eb; /* Tailwindのgray-200 */
            border-radius: 0.375rem; /* Tailwindのrounded-lg */
            color: #374151; /* Tailwindのgray-700 */
            background-color: white;
            font-size: 0.875rem; /* Tailwindのtext-sm */
            transition: all 0.2s;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #f9fafb; /* Tailwindのgray-50 */
            border-color: #d1d5db; /* Tailwindのgray-300 */
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #6366f1; /* Tailwindのindigo-600 */
            color: white;
            border-color: #6366f1;
        }

        .dataTables_filter {
            margin-bottom: 1rem;
        }
        </style>
    </head>
    <body class="bg-gray-50 p-6">
        <div class="max-w-full mx-auto">
            <h1 class="text-2xl font-bold mb-4">CSV Viewer</h1>
            
            <!-- File selector section -->
            <div class="mb-4 p-3 bg-white rounded shadow-sm">
                <label for="file-selector" class="block text-sm font-medium text-gray-700 mb-2">Select CSV File:</label>
                <select id="file-selector" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select a file...</option>
                </select>
            </div>
            
            <!-- File info section -->
            <div id="file-info" class="mb-4 p-3 bg-white rounded shadow-sm"></div>
            
            <!-- Loading indicator -->
            <div id="loading" class="flex items-center justify-center p-6">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <span class="ml-3">Loading CSV data...</span>
            </div>
            
            <!-- Error message -->
            <div id="error-message" class="hidden p-4 mb-4 text-red-700 bg-red-100 rounded-lg"></div>
            
            <!-- Table container -->
            <div id="table-container" class="hidden overflow-x-auto bg-white rounded-lg shadow-lg p-4">
                <table id="csv-table" class="w-full"></table>
            </div>
        </div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const fileSelector = document.getElementById('file-selector');
                const tableContainer = document.getElementById('table-container');
                const loadingIndicator = document.getElementById('loading');
                const errorMessage = document.getElementById('error-message');
                const fileInfo = document.getElementById('file-info');
                
                // Function to show error
                function showError(message) {
                    errorMessage.textContent = message;
                    errorMessage.classList.remove('hidden');
                    loadingIndicator.classList.add('hidden');
                }
                
                // Function to load file list
                function loadFileList() {
                    loadingIndicator.classList.remove('hidden');
                    
                    fetch('/api/data/list/strategies')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load file list');
                            }
                            return response.json();
                        })
                        .then(data => {
                            loadingIndicator.classList.add('hidden');
                            
                            if (!data || !data.files) {
                                throw new Error('Invalid response format');
                            }
                            
                            // Add files to selector
                            data.files.forEach(file => {
                                if (file.path.endsWith('.csv')) {
                                    const option = document.createElement('option');
                                    option.value = file.path;
                                    option.textContent = file.path.split('/').pop();
                                    fileSelector.appendChild(option);
                                }
                            });
                        })
                        .catch(error => {
                            showError('Error loading file list: ' + error.message);
                        });
                }
                
                // Function to load CSV data
                function loadCSVData(filePath) {
                    loadingIndicator.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                    errorMessage.classList.add('hidden');
                    
                    fetch(`/api/data/csv/${filePath}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load CSV file');
                            }
                            return response.json();
                        })
                        .then(response => {
                            // Hide loading indicator
                            loadingIndicator.classList.add('hidden');
                            
                            if (!response || !response.data || !response.data.data) {
                                showError('Invalid response format');
                                return;
                            }
                            
                            const data = response.data.data;
                            
                            if (data.length === 0) {
                                showError('No data found in the CSV file.');
                                return;
                            }
                            
                            // Display file info
                            fileInfo.innerHTML = `
                                <p><strong>File:</strong> ${filePath.split('/').pop()}</p>
                                <p><strong>Rows:</strong> ${data.length}</p>
                                <p><strong>Columns:</strong> ${Object.keys(data[0]).length}</p>
                            `;
                            
                            // Show table container
                            tableContainer.classList.remove('hidden');
                            
                            // Initialize DataTable
                            $('#csv-table').DataTable({
                                destroy: true, // Destroy existing table
                                data: data,
                                columns: Object.keys(data[0]).map(key => ({
                                    title: key,
                                    data: key
                                })),
                                scrollX: true,
                                scrollY: '70vh',
                                scrollCollapse: true,
                                paging: true,
                                searching: true,
                                ordering: true,
                                info: true,
                                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                                pageLength: 25,
                                responsive: true
                            });
                        })
                        .catch(error => {
                            showError('Error loading CSV file: ' + error.message);
                        });
                }
                // Event listener for file selector
                fileSelector.addEventListener('change', function() {
                    if (this.value) {
                        loadCSVData(this.value);
                    }
                });
                
                // Load file list on page load
                loadFileList();
            });
        </script>
    </body>
</html>