<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Wallet Payment</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; }
        button { background-color: #5762d5; color: white; border: none; padding: 10px 20px; 
                border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; }
        .status { margin-top: 20px; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .pending { background-color: #fff3cd; color: #856404; }
        .debug { font-family: monospace; text-align: left; margin-top: 20px; font-size: 12px; 
                background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 200px; overflow: auto; }
    </style>
</head>
<body>
    <h1>Web3 Wallet Payment</h1>
    <p>Send 1 USDT to address:</p>
    <code>0x455EFD272AFab5B9477e4EC298b811f29362ebC6</code>
    
    <div id="buttonContainer">
        <button id="detectBtn">Detect Wallets</button>
        <button id="connectEthBtn">Connect via window.ethereum</button>
        <button id="connectCtrlBtn">Connect via Ctrl Wallet</button>
        <button id="payBtn" disabled>Send 1 USDT</button>
    </div>
    
    <div id="status" class="status"></div>
    <div id="debug" class="debug"></div>
    
    <script>
        // Constants
        const USDT_ADDRESS = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
        const RECIPIENT = '0x455EFD272AFab5B9477e4EC298b811f29362ebC6';
        const AMOUNT = '1000000'; // 1 USDT (6 decimals)
        const TOKEN_ABI = [{"constant":false,"inputs":[{"name":"_to","type":"address"},
                          {"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],
                          "payable":false,"stateMutability":"nonpayable","type":"function"}];
        
        // Variables
        let web3;
        let accounts;
        let usdtContract;
        let providerConnected = false;
        
        // DOM elements
        const statusDiv = document.getElementById('status');
        const debugDiv = document.getElementById('debug');
        const detectBtn = document.getElementById('detectBtn');
        const connectEthBtn = document.getElementById('connectEthBtn');
        const connectCtrlBtn = document.getElementById('connectCtrlBtn');
        const payBtn = document.getElementById('payBtn');
        
        // Helper functions
        function setStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }
        
        function logDebug(message) {
            const line = document.createElement('div');
            line.textContent = message;
            debugDiv.appendChild(line);
            console.log(message);
        }
        
        // Detect available providers
        function detectProviders() {
            logDebug("Detecting wallet providers...");
            
            if (typeof window.ethereum !== 'undefined') {
                logDebug("✓ window.ethereum detected");
                connectEthBtn.disabled = false;
            } else {
                logDebug("✗ window.ethereum not found");
                connectEthBtn.disabled = true;
            }
            
            if (typeof window.ctrl !== 'undefined') {
                logDebug("✓ window.ctrl detected");
                connectCtrlBtn.disabled = false;
            } else {
                logDebug("✗ window.ctrl not found");
                
                // Check for Ctrl specific properties on window
                if (window.ctrlProvider || window.ctrlWallet) {
                    logDebug("✓ Alternative Ctrl Wallet property found");
                    connectCtrlBtn.disabled = false;
                } else {
                    connectCtrlBtn.disabled = true;
                }
            }
            
            // Check for any injected Web3
            if (window.web3 || window.Web3) {
                logDebug("✓ Legacy web3 detected");
            }
            
            // Add properties of window.ethereum to debug
            if (window.ethereum) {
                logDebug("Ethereum provider properties:");
                for (const prop in window.ethereum) {
                    if (typeof window.ethereum[prop] !== 'function') {
                        logDebug(`- ${prop}: ${window.ethereum[prop]}`);
                    }
                }
            }
        }
        
        // Connect via standard Ethereum provider
        async function connectViaEthereum() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    setStatus('No Ethereum provider found', 'error');
                    return;
                }
                
                setStatus('Connecting via window.ethereum...', 'pending');
                
                // Request accounts
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                logDebug(`Connected accounts: ${accounts.join(', ')}`);
                
                // Initialize Web3
                web3 = new Web3(window.ethereum);
                logDebug(`Web3 version: ${web3.version}`);
                
                // Get chainId
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                logDebug(`Connected to chain ID: ${chainId}`);
                
                // Create contract
                usdtContract = new web3.eth.Contract(TOKEN_ABI, USDT_ADDRESS);
                
                // Enable pay button
                providerConnected = true;
                payBtn.disabled = false;
                
                setStatus(`Connected via Ethereum provider. Account: ${accounts[0]}`, 'success');
            } catch (error) {
                console.error(error);
                logDebug(`Error: ${error.message}`);
                setStatus(`Connection error: ${error.message}`, 'error');
            }
        }
        
        // Connect via Ctrl Wallet
        async function connectViaCtrl() {
            try {
                // Try different possible Ctrl Wallet provider options
                let ctrlProvider = null;
                
                if (window.ctrl) {
                    logDebug("Using window.ctrl");
                    ctrlProvider = window.ctrl;
                } else if (window.ctrlProvider) {
                    logDebug("Using window.ctrlProvider");
                    ctrlProvider = window.ctrlProvider;
                } else if (window.ctrlWallet) {
                    logDebug("Using window.ctrlWallet");
                    ctrlProvider = window.ctrlWallet;
                } else if (window.ethereum) {
                    logDebug("Falling back to window.ethereum");
                    ctrlProvider = window.ethereum;
                } else {
                    setStatus('Ctrl Wallet provider not found', 'error');
                    return;
                }
                
                setStatus('Connecting via Ctrl Wallet...', 'pending');
                
                // Request accounts
                accounts = await ctrlProvider.request({ method: 'eth_requestAccounts' });
                logDebug(`Connected accounts: ${accounts.join(', ')}`);
                
                // Initialize Web3
                web3 = new Web3(ctrlProvider);
                logDebug(`Web3 version: ${web3.version}`);
                
                // Get chainId
                const chainId = await ctrlProvider.request({ method: 'eth_chainId' });
                logDebug(`Connected to chain ID: ${chainId}`);
                
                // Create contract
                usdtContract = new web3.eth.Contract(TOKEN_ABI, USDT_ADDRESS);
                
                // Enable pay button
                providerConnected = true;
                payBtn.disabled = false;
                
                setStatus(`Connected via Ctrl Wallet. Account: ${accounts[0]}`, 'success');
            } catch (error) {
                console.error(error);
                logDebug(`Error: ${error.message}`);
                setStatus(`Connection error: ${error.message}`, 'error');
            }
        }
        
        // Send payment
        async function sendPayment() {
            try {
                if (!providerConnected || !accounts || accounts.length === 0) {
                    setStatus('Please connect to a wallet first', 'error');
                    return;
                }
                
                setStatus('Processing payment...', 'pending');
                
                // Send transaction
                const transaction = await usdtContract.methods.transfer(
                    RECIPIENT,
                    AMOUNT
                ).send({ from: accounts[0] });
                
                logDebug(`Transaction hash: ${transaction.transactionHash}`);
                setStatus(`Payment successful! TX: ${transaction.transactionHash}`, 'success');
            } catch (error) {
                console.error(error);
                logDebug(`Payment error: ${error.message}`);
                setStatus(`Payment error: ${error.message}`, 'error');
            }
        }
        
        // Event listeners
        detectBtn.addEventListener('click', detectProviders);
        connectEthBtn.addEventListener('click', connectViaEthereum);
        connectCtrlBtn.addEventListener('click', connectViaCtrl);
        payBtn.addEventListener('click', sendPayment);
        
        // Run detection on page load
        detectProviders();
    </script>
</body>
</html>