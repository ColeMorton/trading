# Security Policy

## üîí Security Scanning & Prevention

This project implements multiple layers of security scanning to prevent vulnerabilities from reaching production.

### Defense-in-Depth Strategy

We use a **layered security approach** to catch vulnerabilities at multiple stages:

```
Layer 1: Pre-Commit Hooks  ‚Üí  Catch issues before commit
Layer 2: Pre-Push Hooks     ‚Üí  Additional validation before push
Layer 3: CI/CD Pre-Commit   ‚Üí  Verify hooks weren't bypassed
Layer 4: CI/CD Bandit Scan  ‚Üí  Explicit security validation
Layer 5: Branch Protection  ‚Üí  Prevent merging failing builds
```

## Security Tools

### 1. Bandit - Static Application Security Testing (SAST)

**What it does:** Scans Python code for common security issues

**When it runs:**

- Locally: During `git commit` (via pre-commit hook)
- Locally: During `git push` (via pre-push hook)
- CI/CD: On every pull request and push
- Manual: `make security-scan` or `poetry run bandit -r app/ -ll`

**Severity levels:**

- `HIGH`: Critical security issues (blocks commit)
- `MEDIUM`: Security concerns (blocks commit with `-ll` flag)
- `LOW`: Minor concerns (informational only)

**Common issues detected:**

- Hardcoded passwords, API keys, secrets
- SQL injection vulnerabilities
- Use of insecure functions (pickle, eval, exec)
- Weak cryptography
- Binding to all network interfaces (0.0.0.0)
- Insecure temporary file usage

### 2. Ruff - Fast Python Linter

**What it does:** Checks code quality and security-related patterns

**Security rules enabled:**

- `S` - Security issues (flake8-bandit equivalent)
- `B` - Bug-prone patterns
- Many others

### 3. MyPy - Static Type Checker

**What it does:** Prevents type-related bugs that could lead to security issues

### 4. Pre-Commit Hooks

**What they do:** Automated checks before every commit

**Configured hooks:**

- detect-private-key: Prevents committing private keys
- check-added-large-files: Prevents accidentally committing large files
- trailing-whitespace, end-of-file-fixer: Code quality
- check-yaml, check-json, check-toml: Configuration validation
- Bandit security scanning
- Ruff formatting and linting
- MyPy type checking
- ESLint and Prettier for frontend code

## Handling Security Findings

### Option 1: Fix the Issue (Preferred)

Always prefer fixing the actual security concern:

```python
# ‚ùå Bad - hardcoded password
password = "my_secret_password"

# ‚úÖ Good - use environment variables
import os
password = os.getenv("DB_PASSWORD")
```

### Option 2: Suppress False Positives

If Bandit flags a false positive, add `# nosec` with a clear justification:

```python
# This is internal trusted cache data only - files generated by this
# application in controlled locations
with open(cache_file, "rb") as f:
    data = pickle.load(f)  # nosec B301 - Internal trusted cache only
```

**Requirements for nosec comments:**

1. Must include the Bandit rule ID (`# nosec B301`)
2. Must explain WHY the code is safe
3. Must be reviewed during code review
4. Should reference documentation if applicable

### Option 3: Exclude Files/Directories

For third-party or generated code, exclude from scanning:

```yaml
# .pre-commit-config.yaml
- id: bandit
  args: ['-ll', '--exclude', 'vendor/,migrations/']
```

## Developer Workflow

### Before Committing

1. **Run pre-commit hooks automatically:**

   ```bash
   git commit -m "Your message"
   # Hooks run automatically
   ```

2. **Or run manually first:**

   ```bash
   # Run all hooks
   poetry run pre-commit run --all-files

   # Run only security scan
   make security-scan

   # Run comprehensive verification
   ./scripts/verify-commit.sh
   ```

3. **Fix any issues found**

4. **Commit with fixes**

### If You Need to Bypass Hooks

‚ö†Ô∏è **WARNING: Bypassing security hooks is strongly discouraged**

If you absolutely must bypass hooks (e.g., work-in-progress commit):

1. **Get approval** from a security lead or senior developer
2. **Document the reason** in the commit message
3. **Fix issues before PR** - CI will block the merge anyway
4. **Use this command:**
   ```bash
   git commit --no-verify -m "WIP: Reason for bypass"
   ```

**Note:** Even if you bypass local hooks, CI will catch the issues and block merging.

## CI/CD Security Checks

### Required Checks

Every pull request and push to `main` or `develop` must pass:

1. **Pre-Commit Check** (`.github/workflows/pre-commit-check.yml`)

   - Runs ALL pre-commit hooks
   - Explicit Bandit security scan
   - Cannot be bypassed

2. **Lint Job** (`.github/workflows/ci-cd.yml`)

   - Ruff format and linting
   - MyPy type checking
   - Bandit security scan

3. **Tests** (Backend, Integration, E2E)
   - Ensures code works correctly
   - Prevents regressions

### Viewing Security Results

**In CI:**

- Check the "üîí Pre-Commit Hooks" job
- Download "bandit-security-results" artifact for detailed JSON report
- Review the job summary for quick overview

**Locally:**

```bash
# Generate JSON report
poetry run bandit -r app/ -ll -f json -o bandit-report.json

# View in terminal
poetry run bandit -r app/ -ll

# Use Makefile target
make security-scan
```

## Security Best Practices

### 1. Never Commit Secrets

‚ùå **Bad:**

```python
API_KEY = "sk_live_abc123xyz789"
DATABASE_URL = "postgresql://user:password@localhost/db"
```

‚úÖ **Good:**

```python
import os
API_KEY = os.getenv("API_KEY")
DATABASE_URL = os.getenv("DATABASE_URL")
```

### 2. Validate Input

‚ùå **Bad:**

```python
def execute_query(user_input):
    query = f"SELECT * FROM users WHERE name = '{user_input}'"
    return db.execute(query)
```

‚úÖ **Good:**

```python
def execute_query(user_input):
    query = "SELECT * FROM users WHERE name = :name"
    return db.execute(query, {"name": user_input})
```

### 3. Use Secure Defaults

‚ùå **Bad:**

```python
app.run(host="0.0.0.0", debug=True)  # Exposed to all, debug on
```

‚úÖ **Good:**

```python
app.run(
    host=os.getenv("API_HOST", "127.0.0.1"),  # Localhost by default
    debug=os.getenv("DEBUG", "false").lower() == "true"
)
```

### 4. Keep Dependencies Updated

```bash
# Check for security vulnerabilities
poetry show --outdated

# Update dependencies
poetry update

# Review changelogs for security fixes
```

## Reporting Security Vulnerabilities

If you discover a security vulnerability:

1. **DO NOT** open a public GitHub issue
2. **DO** email the security team privately: [security contact]
3. **DO** include:
   - Description of the vulnerability
   - Steps to reproduce
   - Potential impact
   - Suggested fix (if any)

## Security Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Bandit Documentation](https://bandit.readthedocs.io/)
- [Python Security Best Practices](https://python.readthedocs.io/en/latest/library/security_warnings.html)
- [CWE - Common Weakness Enumeration](https://cwe.mitre.org/)

## Tooling Reference

### Quick Commands

```bash
# Security scanning
make security-scan                    # Bandit scan
make lint-bandit                      # Same as above

# Pre-commit
make pre-commit-install               # Install hooks
make pre-commit-run                   # Run all hooks manually

# Verification
./scripts/verify-commit.sh            # Full verification
./scripts/verify-commit.sh --quick    # Quick checks
./scripts/verify-commit.sh --security-only  # Security only

# Code quality
make lint-all                         # All linters and formatters
make format-python                    # Auto-format code
```

### Configuration Files

- `.pre-commit-config.yaml` - Pre-commit hook configuration
- `pyproject.toml` - Tool configurations (Ruff, MyPy, Bandit)
- `.github/workflows/pre-commit-check.yml` - CI pre-commit validation
- `.github/workflows/ci-cd.yml` - Main CI/CD pipeline
- `.gitmessage` - Commit message template with security reminders

---

**Remember**: Security is everyone's responsibility. When in doubt, ask for help!
